"""
Finds an irreducible polynomial of the form ``f(x) = x^2 + x + \\varepsilon`` over
the finite field ``\\mathbb{F}_q``.

For quadratic polynomials, irreducibility is equivalent to having no roots in the base field:

```jldoctest
julia> using Oscar

julia> ùîΩ‚ÇÇ, _ = finite_field(2, 1, "a");

julia> R, x = polynomial_ring(ùîΩ‚ÇÇ, "x");

julia> f = x^2 + x + ùîΩ‚ÇÇ(1);

julia> is_irreducible(f) && isempty(roots(f))
true

julia> g = x^2 + x + ùîΩ‚ÇÇ(0);

julia> is_irreducible(g) || !isempty(roots(g))
true
```

In characteristic 2, the standard quadratic form ``x^2 + \\varepsilon`` is insufficient because
its derivative is zero, making it inseparable if it has a root. The form ``x^2 + x + \\varepsilon``
is used instead, as its derivative is 1, ensuring separability. Its irreducibility over ``\\mathbb{F}_q``
is equivalent to it having no roots in ``\\mathbb{F}_q``.

```jldoctest
julia> using Oscar

julia> ùîΩ‚ÇÇ, _ = finite_field(2, 1, "a");

julia> R, x = polynomial_ring(ùîΩ‚ÇÇ, "x");

julia> f = x^2 + ùîΩ‚ÇÇ(1);

julia> derivative(f) == 0 && !is_separable(f)
true

julia> ùîΩ‚ÇÑ, _ = finite_field(2, 2, "b");

julia> R‚ÇÑ, y = polynomial_ring(ùîΩ‚ÇÑ, "y");

julia> factor(y^2 + ùîΩ‚ÇÑ(1))
1 * (y + 1)^2
```

The form ``x^2 + x + \\varepsilon`` works correctly in characteristic 2, making it
essential for applications like the construction of optimal expander graphs:

```jldoctest
julia> using Oscar

julia> ùîΩ‚ÇÇ, _ = finite_field(2, 1, "a");

julia> R, x = polynomial_ring(ùîΩ‚ÇÇ, "x");

julia> f = x^2 + x + ùîΩ‚ÇÇ(1);

julia> is_irreducible(f) && is_separable(f) && derivative(f) == 1
true
```

# Morgenstern's construction of Ramanujan graphs

The construction requires a [quaternion algebra](https://en.wikipedia.org/wiki/Quaternion_algebra)
over ``\\mathbb{F}_q(x)`` of the form [morgenstern1994existence](@cite):

```math
\\begin{aligned}
\\mathcal{A} = k\\mathbf{1} + k\\mathbf{i} + k\\mathbf{j} + k\\mathbf{ij}, \\quad
\\mathbf{i}^2 = \\mathbf{i} + \\varepsilon, \\quad \\mathbf{j}^2 = x, \\quad \\mathbf{ij} = \\mathbf{ji} + \\mathbf{j}
\\end{aligned}
```

where ``k = \\mathbb{F}_q(x)`` and ``f(x) = x^2 + x + \\varepsilon`` is irreducible over ``\\mathbb{F}_q``.

The norm in this algebra is given by:

```math
\\begin{aligned}
N(a + b\\mathbf{i} + c\\mathbf{j} + d\\mathbf{ij}) = a^2 + b^2\\varepsilon + ab + (c^2 + d^2\\varepsilon + cd)x
\\end{aligned}
```

The "basic norm" elements that generate the Ramanujan graphs are exactly those of the form [morgenstern1994existence](@cite):

```math
\\begin{aligned}
\\xi = 1 + \\gamma\\mathbf{j} + \\delta\\mathbf{ij}, \\quad \\text{where } \\gamma, \\delta \\in \\mathbb{F}_q
\\end{aligned}
```

satisfy

```math
\\begin{aligned}
\\gamma^2 + \\gamma\\delta + \\delta^2\\varepsilon = 1
\\end{aligned}
```

This equation has exactly ``q+1`` solutions in ``\\mathbb{F}_q``, providing the ``q+1`` generators needed 
for ``(q+1)``-regular Ramanujan graphs.

Under the isomorphism ``\\theta: \\mathcal{A} \\to M_2(k)``, these generators map to matrices [morgenstern1994existence](@cite):

```math
\\begin{pmatrix}
1 & \\gamma + \\delta i \\\\
(\\gamma + \\delta i + \\delta)x & 1
\\end{pmatrix}
```

where ``i`` is a root of ``x^2 + x + \\varepsilon = 0``.

In characteristic 2, the polynomial ``x^2 + \\varepsilon`` is inseparable because its derivative is
zero. As a result, it cannot be used to define a separable quadratic field extension, which is necessary
for constructing a division quaternion algebra in Morgenstern‚Äôs Ramanujan graph construction. In contrast, 
``x^2 + x + \\varepsilon``, being both irreducible and separable, yields a proper non-split quaternion algebra.
Without separability, the resulting graphs do not attain the Ramanujan eigenvalue bound ``2\\sqrt{q}``,
violating the optimality of the construction.

# Arguments
- `R`: Polynomial ring ``\\mathbb{F}_q[x]`` used to construct the irreducible polynomial for Morgenstern's quaternion algebra.

"""
function morgenstern_f(R::FqPolyRing)
    x = gen(R)
    count = 0
    while true
        count += 1
        Œµ = rand(base_ring(R))
        p = x^2+x+Œµ
        if is_irreducible(p)
            @debug "Found irreducible polynomial after $count attempts: $p"
            return p
        end
    end
end

"""
Find all ``q + 1`` solutions ``(\\gamma, \\delta) \\in \\mathbb{F}_q^2`` to the
``\\gamma^2 + \\gamma\\delta + \\delta^2\\varepsilon = 1``.

## Quaternion Algebra

A [quaternion algebra](https://en.wikipedia.org/wiki/Quaternion_algebra) over ``k = \\mathbb{F}_q(x)`` is
a [skewfield](https://en.wikipedia.org/wiki/Division_ring) ``\\mathcal{A}`` with [center](https://en.wikipedia.org/wiki/Center_(group_theory))
``k`` that has degree four as a vector space over ``k``. In Morgenstern's explicit construction of Ramanujan graphs
for even characteristic ``q`` [morgenstern1994existence](@cite), a specific quaternion algebra is defined as

```math
\\begin{aligned}
\\mathscr{A} = k\\mathbf{1} + k\\mathbf{i} + k\\mathbf{j} + k\\mathbf{ij}
\\end{aligned}
```

with relations

```math
\\begin{aligned}
\\mathbf{i}^2 = \\mathbf{i} + \\varepsilon, \\mathbf{j}^2 = x, \\mathbf{ij} = \\mathbf{ji} + \\mathbf{j}
\\end{aligned}
```

The parameter ``\\varepsilon \\in \\mathbb{F}_q`` is chosen so that the polynomial ``f(x) = x^2 + x + \\varepsilon``
is irreducible over ``\\mathbb{F}_q``. This ensures ``\\mathcal{A}`` is a skewfield. The algebra is [ramified](https://en.wikipedia.org/wiki/Ramification_(mathematics))
at the finite place ``x`` and at ``1/x``.

The connection to graph theory arises from studying elements in the integral set

```math
\\begin{aligned}
\\mathscr{S} = \\mathbb{F}_q[x]\\mathbf{1} + \\mathbb{F}_q[x]\\mathbf{i} + \\mathbb{F}_q[x]\\mathbf{j} + \\mathbb{F}_q[x]\\mathbf{ij}
\\end{aligned}
```

The "basic norm x+1" elements are defined as

```math
\\begin{aligned}
\\xi = 1 + \\gamma\\mathbf{j} + \\delta\\mathbf{ij}, \\quad \\text{with} \\gamma, \\delta \\in \\mathbb{F}_q,
\\end{aligned}
```

satisfying the norm equation ``N(\\xi) = \\gamma^2 + \\gamma\\delta + \\delta^2\varepsilon = 1``. This equation
has exactly ``q+1`` solutions in ``\\mathbb{F}_q``, parameterizing generators ``\\xi_1, \\dots, \\xi_{q+1}``. These
generators define a [free product](https://en.wikipedia.org/wiki/Free_product) group 

```math
\\begin{aligned}
A(x) = \\langle \\xi_1 \\rangle * \\langle \\xi_2 \\rangle * \\cdots * \\langle \\xi_{q+1} \\rangle
\\end{aligned}
```

which acts simply transitively on the ``q+1``-regular tree ``T_{x+1} = G'_{x+1}/G'_{O_{x+1}}``. Taking the
quotient by a [congruence subgroup](https://en.wikipedia.org/wiki/Congruence_subgroup) ``A(g)``, where ``g(x)``
is irreducible of even degree, yields a finite ``(q+1)``-regular graph ``\\Gamma_g = A(g) \\backslash T_{x+1}``.
This graph is the Cayley graph of ``PSL_2(\\mathbb{F}_{q^d})`` with respect to the images of the ``q+1`` generators.

# Arguments
- `R`: Polynomial ring ``\\mathbb{F}_q[x]`` where `q` is a power of 2.
"""
function morgenstern_solutions(R::FqPolyRing)
    F = base_ring(R)
    unit = gen(F)
    q = order(F)
    f = morgenstern_f(R) # random sampler
    Œµ = coeff(f, 0)
    # (1, 0) is always a solution: 1¬≤ + 1¬∑0 + 0¬≤¬∑Œµ = 1
    sols = [(one(F),zero(F))]
    # Theorem 5.13 of [morgenstern1994existence](@cite): find all solutions (Œ≥, Œ¥) ‚àà ùîΩq¬≤ to Œ≥¬≤ + Œ≥Œ¥ + Œ¥¬≤Œµ = 1
    for Œ¥ in F
        iszero(Œ¥) && continue
        for Œ≥ in F
            if Œ≥^2+Œ≥*Œ¥+Œ¥^2*Œµ == one(F)
                push!(sols, (Œ≥, Œ¥))
                # in GF2, if (Œ≥, Œ¥) is solution, so is (Œ≥+Œ¥, Œ¥)
                other_Œ≥ = Œ≥+Œ¥
                push!(sols, (other_Œ≥, Œ¥))
                break
            end
        end
    end
    @assert length(unique(sols)) == q+1
    return Œµ, unique(sols)
end

"""
The theorem *5.13* of [morgenstern1994existence](@cite) provides a method to construct families of
(q+1)-regular Ramanujan graphs for **even prime** powers q. This explicit construction produces Cayley
graphs of the *projective special linear group* ``\\mathrm{PSL}_2(\\mathbb{F}_{q^d})`` with respect to a
specific set of ``q+1`` generators. These generators are ``2 \\times 2`` matrices of the form:

```math
\\begin{aligned}
\\begin{pmatrix}
1 & \\gamma_k + \\delta_k\\mathbb{i} \\\\
(\\gamma_k + \\delta_k\\mathbb{i} + \\delta_k)x & 1
\\end{pmatrix}, \\quad k=1,\\ldots,q+1
\\end{aligned}
```

where q = 2^l is an *even* prime power, and d is an even integer extension degree. The field ``\\mathbb{F}_{q^d}`` is
constructed as ``\\mathbb{F}_q[x]/g(x)\\mathbb{F}_q[x]`` where g(x) is an irreducible polynomial of degree d. Within
this field, ``\\mathbb{i}`` denotes a root of the irreducible polynomial ``x^2 + x + \\varepsilon = 0``. The pairs
``(\\gamma_k, \\delta_k)`` are the q+1 solutions in `\\mathbb{F}_q^2`` to the ``\\gamma_k^2 + \\gamma_k\\delta_k + \\delta_k^2\\varepsilon = 1``.
And x is the polynomial variable that represents an element of ``\\mathbb{F}_{q^d}`` in the construction.

The same theorem states that the resulting Cayley graph ``\\Gamma_g`` has the following properties: it is
a (q+1)-regular Ramanujan graph of order ``|\\Gamma_g| = q^{3d} - q^d`` and is non-bipartite. The graph has
girth at least ``\\frac{2}{3}\\log_q|\\Gamma_g|`` and diameter at most ``2\\log_q|\\Gamma_g| + 2``. Furthermore,
as per Theorem *5.11*, all eigenvalues ``\\mu`` of the adjacency matrix satisfy ``|\\mu| \\leq 2\\sqrt{q}`` for ``\\mu \\neq ``\\pm(q+1)``.

# Arguments
- `l`: A positive integer specifying that q = 2^l, where q is the size of the base field ``\\mathbb{F}_q``.
- `i`: An *even* positive integer specifying the extension degree for the field ``\\mathbb{F}_{q^i}``. 
"""
function morgenstern_generators(l::Int, i::Int)
    @assert iseven(i) "Extension degree i must be even for Morgenstern construction (Theorem 5.13) of [morgenstern1994existence](@cite)"
    p = 2
    q = p^l
    q‚Å± = q^i
    # finite fields ùîΩ_q and extension ùîΩ_q‚Å± as in Section 5
    ùîΩq, _ = finite_field(p, l)
    ùîΩq‚Å±, _ = finite_field(p, l * i)
    # Embedding morphism from ùîΩ_q to ùîΩ_q‚Å± for field extension
    morph = embed(ùîΩq, ùîΩq‚Å±)
    # Given irreducible polynomial x¬≤ + x + Œµ, find solutions to Œ≥¬≤ + Œ≥Œ¥ + Œ¥¬≤Œµ = 1
    RùîΩq, x = polynomial_ring(ùîΩq, :x)
    Œµ, Bsols = morgenstern_solutions(RùîΩq)
    # Theorem 5.13: There are exactly q+1 solutions (Œ≥,Œ¥) ‚àà ùîΩ_q¬≤ to Œ≥¬≤ + Œ≥Œ¥ + Œ¥¬≤Œµ = 1
    @assert length(Bsols) == q + 1 "Expected $((q+1)) solutions as per Theorem 5.13"
    RùîΩq‚Å±, y = polynomial_ring(ùîΩq‚Å±, :y)
    ùïös = roots(y^2+y+morph(Œµ))
    @assert length(ùïös) == 2 "Irreducible quadratic x¬≤ + x + Œµ must have exactly 2 roots in extension field ùîΩ_q‚Å±"
    ùïö = rand(ùïös) # selecting one of the two roots at random
    # Note: In characteristic 2, PSL‚ÇÇ(ùîΩ_q‚Å±) = SL‚ÇÇ(ùîΩ_q‚Å±).
    SL‚ÇÇq‚Å± = SL(2, ùîΩq‚Å±)
    @info "|SL‚ÇÇ(ùîΩ($(q‚Å±)))| = $(order(SL‚ÇÇq‚Å±))"
    order(SL‚ÇÇq‚Å±) > 10_000 && @warn "We are working with a very big group, this will take a long time."
    order(SL‚ÇÇq‚Å±) > 300_000 && throw(ArgumentError("The group is too big, we refuse to even try to proceed."))
    B = eltype(SL‚ÇÇq‚Å±)[]
    x·µ•‚Çê‚Çó = gen(ùîΩq‚Å±)
    for (Œ≥, Œ¥) in Bsols
        # Embed Œ≥, Œ¥ from ùîΩ_q to ùîΩ_q‚Å±
        Œ≥ = morph(Œ≥)
        Œ¥ = morph(Œ¥)
        # see Eq. 21 of [morgenstern1994existence](@cite)
        mat = matrix(ùîΩq‚Å±, [1              Œ≥+Œ¥*ùïö; 
                           (Œ≥+Œ¥*ùïö+Œ¥)*x·µ•‚Çê‚Çó     1])
        # normalize the matrix to have determinant 1 for SL‚ÇÇ
        det‚Çò‚Çê‚Çú = det(mat)
        @assert !iszero(det‚Çò‚Çê‚Çú) "Generator matrix must be invertible"
        normalized‚Çò‚Çê‚Çú = mat*inv(sqrt(det‚Çò‚Çê‚Çú))
        @assert det(normalized‚Çò‚Çê‚Çú) == one(ùîΩq‚Å±) "Normalized matrix must have determinant 1 for SL‚ÇÇ"
        g = SL‚ÇÇq‚Å±(normalized‚Çò‚Çê‚Çú)
        @assert g^2 == one(SL‚ÇÇq‚Å±) "Each generator must have order 2 (Theorem 5.13)"
        push!(B, g)
    end
    return SL‚ÇÇq‚Å±, B
end

abstract type MorgensternAlgorithm end

struct AllPairs <: MorgensternAlgorithm end
struct FirstOnly <: MorgensternAlgorithm end

"""
Create alternative Morgenstern generators using all pairwise products (i‚â†j).

Introduced in Sec. 6.1 of [dinur2022locally](@cite).
Building upon [morgenstern1994existence](@cite).
"""
function alternative_morgenstern_generators(B::AbstractVector, ::AllPairs)
    A = eltype(B)[]
    N = length(B)
    for i in 1:N
        for j in 1:N
            if i!=j
                a = B[i]*B[j]
                push!(A,a)
            end
        end
    end
    return A
end

"""
Create alternative Morgenstern generators using products with first element only.

Introduced as the "better" alternative in Sec. 6.1 of [dinur2022locally](@cite).
Building upon [morgenstern1994existence](@cite).
"""
function alternative_morgenstern_generators(B::AbstractVector, ::FirstOnly)
    A = eltype(B)[]
    N = length(B)
    for i in 2:N
        push!(A,B[1]*B[i])
        push!(A,B[i]*B[1])
    end
    return A
end

alternative_morgenstern_generators(B) = alternative_morgenstern_generators(B, FirstOnly())
